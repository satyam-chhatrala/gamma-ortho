<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gamma Ortho - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Manrope', sans-serif; 
            background-color: #18181b; /* zinc-900 */
            color: #e4e4e7; /* zinc-200 */
        }
        .admin-container { 
            max-width: 1200px; 
            margin: 2rem auto; 
            padding: 2rem; 
            background-color: #27272a; /* zinc-800 */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1); /* shadow-lg */
        }
        .form-section { /* For Add/Edit Product form */
            margin-bottom: 2.5rem; 
            padding: 2rem; 
            background-color: #3f3f46; /* zinc-700 */
            border-radius: 0.5rem; /* rounded-lg */
            border: 1px solid #52525b; /* zinc-600 */
        }
        .list-section { /* For "Listed Products" section */
            margin-bottom: 2.5rem; 
            padding: 2rem; 
            /* background-color: #3f3f46; /* REMOVED - Will inherit from admin-container */
            border-radius: 0.5rem; /* rounded-lg */
            border: 1px solid #52525b; /* zinc-600 - Thin "white" border */
        }
        
        label { 
            display: block; 
            margin-bottom: 0.5rem; 
            font-weight: 500; 
            color: #d4d4d8; /* zinc-300 */
        }
        .input-field, .select-field, .textarea-field, .file-input-styled {
            width: 100%;
            padding: 0.85rem 1rem; 
            border-radius: 0.5rem; 
            border: 1px solid #52525b; /* zinc-600 */
            background-color: #27272a; /* zinc-800 */
            color: #e4e4e7; /* zinc-200 */
            margin-bottom: 1.25rem; 
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-field::placeholder, .textarea-field::placeholder, .select-field option {
            color: #a1a1aa; /* zinc-400 */
        }
        .file-input-styled::file-selector-button {
            font-weight: 600;
            color: #18181b; 
            background-color: #a1a1aa; 
            border: none;
            padding: 0.6rem 1rem;
            margin-right: 0.75rem;
            border-radius: 0.375rem; 
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .file-input-styled::file-selector-button:hover {
            background-color: #b9b9c0; 
        }
        .input-field:focus, .select-field:focus, .textarea-field:focus, .file-input-styled:focus {
            outline: none;
            border-color: #a1a1aa; 
            box-shadow: 0 0 0 3px rgba(161, 161, 170, 0.4); 
        }
        .btn {
            padding: 0.85rem 1.75rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s, color 0.2s, border-color 0.2s;
            text-align: center;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px -1px rgba(0,0,0,0.1);
            border: 1px solid transparent;
        }
        .btn:hover {
             transform: translateY(-1px);
        }
        .btn-primary { 
            background-color: #f4f4f5; 
            color: #18181b; 
            border-color: #f4f4f5;
        }
        .btn-primary:hover { 
            background-color: #e4e4e7; 
            border-color: #e4e4e7;
        }
        .btn-secondary { 
            background-color: #3f3f46; 
            color: #f4f4f5; 
            border-color: #52525b; 
        }
        .btn-secondary:hover { 
            background-color: #52525b; 
            border-color: #71717a; 
        }
        .btn-warning { 
            background-color: transparent; 
            color: #e4e4e7; 
            border: 1px solid #71717a; 
        }
        .btn-warning:hover { 
            background-color: #27272a; 
            border-color: #a1a1aa; 
            color: #f4f4f5; 
        }
        .btn-danger { 
            background-color: #b91c1c; 
            color: white; 
            border-color: #b91c1c;
        }
        .btn-danger:hover { 
            background-color: #991b1b; 
            border-color: #991b1b;
        }
        .btn-sm { padding: 0.6rem 1.2rem; font-size: 0.875rem; }

        .dimension-entry { display: flex; gap: 0.75rem; align-items: center; margin-bottom: 0.75rem; }
        .dimension-entry input { margin-bottom: 0; } 
        
        #admin-feedback { 
            margin-top: 1.5rem; 
            padding: 1rem; 
            border-radius: 0.5rem; 
            text-align: center; 
            font-weight: 500;
        }
        .feedback-success { background-color: #27272a; border: 1px solid #4d7c0f; color: #a3e635; } 
        .feedback-error { background-color: #27272a; border: 1px solid #b91c1c; color: #f87171; } 
        .feedback-info { background-color: #27272a; border: 1px solid #52525b; color: #e4e4e7; } 
        
        .hidden { display: none !important; } 
        .image-preview-container { margin-top: 0.75rem; margin-bottom: 1rem; }
        .image-preview { max-width: 120px; max-height: 120px; margin-right: 0.75rem; border-radius: 0.375rem; border: 1px solid #52525b; }
        
        .admin-product-card {
            background-color: #18181b; /* zinc-900 - Card background changed to blacker tone */
            border: 1px solid #3f3f46; /* zinc-700 - Border for card */
            border-radius: 0.75rem; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1); 
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .admin-product-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1); 
        }
        .admin-product-card-image-container { 
            position: relative;
            width: 100%; 
            height: 12rem; 
            background-color: #3f3f46; /* zinc-700 - Background for image container */
            border-bottom: 1px solid #27272a; /* zinc-800 - Adjusted border */
        }
        .admin-product-card-image { 
            width: 100%; 
            height: 100%; 
            object-fit: contain; 
            padding: 0.5rem; 
        }
        .admin-carousel-arrow { 
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(24, 24, 27, 0.5); 
            color: #f4f4f5; 
            border: none;
            border-radius: 50%;
            width: 2rem; 
            height: 2rem; 
            font-size: 1rem; 
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
            z-index: 10;
        }
        .admin-carousel-arrow:hover {
            background-color: rgba(39, 39, 42, 0.7); 
        }
        .admin-carousel-arrow.prev-arrow { left: 0.5rem; }
        .admin-carousel-arrow.next-arrow { right: 0.5rem; }

        .admin-product-card-content {
            padding: 1rem; 
            flex-grow: 1; 
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .admin-product-card h4 { color: #f4f4f5; font-size: 1.125rem; margin-bottom: 0.25rem; }
        .admin-product-card p { color: #a1a1aa; font-size: 0.875rem; margin-bottom: 0.25rem;}
        .admin-product-card .actions { margin-top: 1rem; display: flex; gap: 0.5rem; justify-content: space-between; }
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem; 
            font-size: 0.75rem; 
            font-weight: 600; 
            border-radius: 9999px; 
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .status-badge-active {
            background-color: #22c55e; 
            color: #f0fdf4; 
        }
        .status-badge-inactive {
            background-color: #ef4444; 
            color: #fef2f2; 
        }


        #admin-product-filter-options-container { 
            margin-bottom: 1.5rem; 
            padding: 1.5rem; 
            background-color: #27272a; 
            border-radius: 0.5rem; 
            border: 1px solid #3f3f46; 
        }
        #admin-product-filter-options-container h3 {
            font-size: 1.125rem; 
            font-weight: 600; 
            color: #e4e4e7; 
            margin-bottom: 0.75rem; 
        }
        .admin-product-filter-options {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem; 
        }
        .admin-product-filter-options label {
            display: flex;
            align-items: center;
            padding: 0.6rem 1rem; 
            background-color: #3f3f46; 
            color: #d4d4d8; 
            border-radius: 0.5rem; 
            border: 1px solid #52525b; 
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }
        .admin-product-filter-options label:hover, 
        .admin-product-filter-options input[type="checkbox"]:checked + span {
            background-color: #52525b; 
            color: #f4f4f5; 
        }
        .admin-product-filter-options input[type="checkbox"] {
            opacity: 0;
            position: absolute;
            width: 1px;
            height: 1px;
        }
        #admin-filter-toggle-button { 
            padding: 0.85rem; 
            background-color: #3f3f46; 
            border: 1px solid #52525b; 
            border-radius: 0.5rem; 
            transition: background-color 0.2s;
            color: #e4e4e7; 
        }
        #admin-filter-toggle-button:hover {
            background-color: #52525b; 
        }

        #fab-add-product {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1000;
            border-radius: 50%;
            width: 4rem; 
            height: 4rem; 
            padding: 0; 
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
        }
        #fab-add-product i {
            font-size: 1.75rem; 
        }

    </style>
</head>
<body>
    <div class="admin-container">
        <header class="mb-10 text-center"> 
            <h1 class="text-4xl font-bold text-zinc-100">Gamma Ortho - Admin Panel</h1>
        </header>

        <div id="product-list-view">
            <div class="flex items-center gap-x-4 mb-6 max-w-full">
                <button id="admin-filter-toggle-button" class="focus:outline-none focus:ring-2 focus:ring-zinc-500">
                    <i class="fas fa-filter text-xl"></i>
                </button>
                <input type="text" id="admin-product-search-input" placeholder="Search products by name..." class="input-field !mb-0 flex-grow">
            </div>

            <div id="admin-product-filter-options-container" class="hidden mb-8">
                <h3 class="text-zinc-100">Filter by Product Type:</h3>
                <div id="admin-product-type-filter-options" class="admin-product-filter-options">
                    <label><input type="checkbox" class="admin-product-type-filter" value="all" checked><span>All</span></label>
                    <label><input type="checkbox" class="admin-product-type-filter" value="wire-pin"><span>Wire/Pin</span></label>
                    <label><input type="checkbox" class="admin-product-type-filter" value="ao-fixator"><span>AO-Fixator</span></label>
                    <label><input type="checkbox" class="admin-product-type-filter" value="jess-fixator"><span>Jess Fixator</span></label>
                    <label><input type="checkbox" class="admin-product-type-filter" value="ring-fixator"><span>Ring Fixator</span></label>
                    <label><input type="checkbox" class="admin-product-type-filter" value="rail-fixator"><span>Rail Fixator</span></label>
                </div>
            </div>
            
            <section class="list-section" id="existing-products-section">
                <h3 class="text-2xl font-semibold mb-6 text-zinc-100">Listed Products</h3>
                <div id="existing-products-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <p class="text-center text-zinc-400 col-span-full">Loading products...</p>
                </div>
            </section>
        </div>

        <div id="product-form-view" class="hidden">
            <section class="form-section" id="product-form-section">
                <h2 id="form-title" class="text-3xl font-semibold mb-8 text-zinc-100">Add New Product</h2>
                <form id="product-form" enctype="multipart/form-data" class="space-y-6">
                    <input type="hidden" id="product-id" name="productId"> 
                    <div>
                        <input type="text" id="product-name" name="name" class="input-field" placeholder="Product Name *" required>
                    </div>
                    <div>
                        <textarea id="product-description" name="description" rows="4" class="textarea-field" placeholder="Description *" required></textarea>
                    </div>
                    <div>
                        <select id="product-type-select" name="productTypeSelect" class="select-field" required>
                            <option value="">-- Select Product Type * --</option>
                            <option value="wire-pin">Wire and Pin</option>
                            <option value="ao-fixator">A O-Fixator</option>
                            <option value="jess-fixator">Jess Fixator</option>
                            <option value="ring-fixator">Ring Fixator</option>
                            <option value="rail-fixator">Rail Fixator</option>
                            <option value="other">Other (Please specify)</option>
                        </select>
                    </div>
                    <div id="new-product-type-container" class="hidden"> 
                        <input type="text" id="new-product-type-input" name="newProductType" class="input-field" placeholder="Specify New Product Type">
                    </div>

                    <div class="pt-2">
                        <label class="text-lg font-medium mb-3 text-zinc-200">Dimensions & Pricing (Base Price before GST)</label>
                        <div id="dimensions-container" class="space-y-3">
                            {/* Dimension entries will be added here by JavaScript */}
                        </div>
                        <button type="button" id="add-dimension-btn" class="btn btn-secondary btn-sm mt-3">
                            <i class="fas fa-plus mr-1"></i> Add Dimension
                        </button>
                    </div>
                    
                    <div>
                        <input type="number" id="product-gst-rate" name="gstRate" class="input-field" step="0.01" min="0" max="1" value="0.12" placeholder="GST Rate (e.g., 0.12 for 12%) *" required>
                    </div>

                    <div>
                        <label for="product-base-image" class="text-zinc-300 mb-1">Base Image</label>
                        <input type="file" id="product-base-image" name="baseImage" class="file-input-styled">
                        <div id="base-image-preview-container" class="image-preview-container"></div>
                        <input type="hidden" id="existing-base-image-url" name="baseImageURL">
                    </div>
                    <div>
                        <label for="product-additional-images" class="text-zinc-300 mb-1">Additional Images (Select new to replace all)</label>
                        <input type="file" id="product-additional-images" name="additionalImages" class="file-input-styled" multiple>
                        <div id="additional-images-preview-container" class="image-preview-container flex flex-wrap gap-2"></div>
                    </div>

                    <div class="flex items-center">
                        <input type="checkbox" id="product-is-active" name="isActive" class="mr-2 h-5 w-5 accent-zinc-400 rounded" checked>
                        <label for="product-is-active" class="mb-0 text-zinc-300">Product is Active (Visible on customer site)</label>
                    </div>

                    <div class="mt-8 flex space-x-4">
                        <button type="submit" id="submit-product-btn" class="btn btn-primary w-full">Add Product</button>
                        <button type="button" id="cancel-edit-btn" class="btn btn-secondary w-full hidden">Cancel Edit</button>
                        <button type="button" id="back-to-list-btn" class="btn btn-secondary w-full">Back to List</button> 
                    </div>
                </form>
                <div id="admin-feedback"></div>
            </section>
        </div>

        <button id="fab-add-product" class="btn btn-primary fixed bottom-6 right-6">
            <i class="fas fa-plus"></i>
        </button>
    </div>

    <script>
        const BACKEND_URL = 'https://gamma-ortho.onrender.com'; 
        const GST_RATE_DEFAULT = 0.12; 

        const productForm = document.getElementById('product-form');
        const formTitle = document.getElementById('form-title');
        const productFormSection = document.getElementById('product-form-section'); 
        const productIdInput = document.getElementById('product-id');
        const productNameInput = document.getElementById('product-name');
        const productDescriptionInput = document.getElementById('product-description');
        const productTypeSelect = document.getElementById('product-type-select');
        const newProductTypeContainer = document.getElementById('new-product-type-container');
        const newProductTypeInput = document.getElementById('new-product-type-input');
        const dimensionsContainer = document.getElementById('dimensions-container');
        const addDimensionBtn = document.getElementById('add-dimension-btn');
        const productGstRateInput = document.getElementById('product-gst-rate');
        const productBaseImageInput = document.getElementById('product-base-image');
        const baseImagePreviewContainer = document.getElementById('base-image-preview-container');
        const existingBaseImageUrlInput = document.getElementById('existing-base-image-url');
        const productAdditionalImagesInput = document.getElementById('product-additional-images');
        const additionalImagesPreviewContainer = document.getElementById('additional-images-preview-container');
        const productIsActiveCheckbox = document.getElementById('product-is-active');
        const submitProductBtn = document.getElementById('submit-product-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const adminFeedback = document.getElementById('admin-feedback');
        const existingProductsList = document.getElementById('existing-products-list');

        const productListView = document.getElementById('product-list-view');
        const productFormView = document.getElementById('product-form-view');
        const fabAddProduct = document.getElementById('fab-add-product');
        const backToListBtn = document.getElementById('back-to-list-btn');

        const adminProductSearchInput = document.getElementById('admin-product-search-input');
        const adminProductTypeFilters = document.querySelectorAll('.admin-product-type-filter');
        const adminFilterToggleButton = document.getElementById('admin-filter-toggle-button'); 
        const adminProductFilterOptionsContainer = document.getElementById('admin-product-filter-options-container'); 

        let allAdminProducts = []; 


        let editMode = false;

        function showListView() {
            productListView.classList.remove('hidden');
            productFormView.classList.add('hidden');
            fabAddProduct.classList.remove('hidden'); 
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function showFormView(isEditing = false, productToEdit = null) {
            productListView.classList.add('hidden');
            productFormView.classList.remove('hidden');
            fabAddProduct.classList.add('hidden'); 
            
            editMode = isEditing;
            if (isEditing && productToEdit) {
                populateFormForEdit(productToEdit);
            } else {
                resetFormToCreateMode();
            }
            window.scrollTo({ top: productFormSection.offsetTop - 20, behavior: 'smooth' });
        }


        function displayFeedback(message, type) {
            adminFeedback.textContent = message;
            adminFeedback.className = ''; 
            if (type === 'success') {
                adminFeedback.classList.add('feedback-success');
            } else if (type === 'error') {
                adminFeedback.classList.add('feedback-error');
            } else {
                 adminFeedback.classList.add('feedback-info');
            }
            setTimeout(() => {
                adminFeedback.textContent = '';
                adminFeedback.className = '';
            }, 7000); 
        }

        function addDimensionEntry(dimension = { dimensionName: '', basePrice: '' }) {
            const entryCount = dimensionsContainer.children.length;
            const dimensionEntry = document.createElement('div');
            dimensionEntry.className = 'dimension-entry';
            dimensionEntry.innerHTML = `
                <input type="text" name="dimensionName-${entryCount}" placeholder="Dimension Name *" class="input-field flex-grow" value="${dimension.dimensionName || ''}" required>
                <input type="number" name="basePrice-${entryCount}" placeholder="Base Price *" class="input-field w-1/3" step="0.01" min="0" value="${dimension.basePrice || ''}" required>
                <button type="button" class="btn btn-danger btn-sm p-2 rounded remove-dimension-btn" title="Remove Dimension">
                    <i class="fas fa-times"></i>
                </button>
            `;
            dimensionsContainer.appendChild(dimensionEntry);
            dimensionEntry.querySelector('.remove-dimension-btn').addEventListener('click', function() {
                this.parentElement.remove();
            });
        }
        
        function resetFormToCreateMode() {
            formTitle.textContent = 'Add New Product';
            productForm.reset();
            productIdInput.value = ''; 
            dimensionsContainer.innerHTML = '';
            addDimensionEntry(); 
            productGstRateInput.value = GST_RATE_DEFAULT;
            productIsActiveCheckbox.checked = true;
            submitProductBtn.textContent = 'Add Product';
            submitProductBtn.classList.remove('btn-warning');
            submitProductBtn.classList.add('btn-primary');
            cancelEditBtn.classList.add('hidden'); 
            backToListBtn.classList.remove('hidden'); 
            baseImagePreviewContainer.innerHTML = '';
            additionalImagesPreviewContainer.innerHTML = '';
            existingBaseImageUrlInput.value = '';
            productTypeSelect.value = '';
            newProductTypeContainer.style.display = 'none';
            newProductTypeInput.required = false;
            editMode = false;
        }

        addDimensionBtn.addEventListener('click', () => addDimensionEntry());
        
        cancelEditBtn.addEventListener('click', () => {
            resetFormToCreateMode();
            showListView();
        });
        
        backToListBtn.addEventListener('click', () => {
            resetFormToCreateMode(); 
            showListView();
        });

        fabAddProduct.addEventListener('click', () => {
            showFormView(false); 
        });


        productTypeSelect.addEventListener('change', function() {
            if (this.value === 'other') {
                newProductTypeContainer.style.display = 'block';
                newProductTypeInput.required = true;
                 newProductTypeInput.focus();
            } else {
                newProductTypeContainer.style.display = 'none';
                newProductTypeInput.required = false;
                newProductTypeInput.value = '';
            }
        });

        productForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            adminFeedback.textContent = 'Processing...';
            adminFeedback.className = 'feedback-info';

            const formData = new FormData(); 

            formData.append('name', productNameInput.value);
            formData.append('description', productDescriptionInput.value);
            
            formData.append('productTypeSelect', productTypeSelect.value);
            if (productTypeSelect.value === 'other') {
                const newType = newProductTypeInput.value.trim();
                if (!newType) {
                    displayFeedback('Please specify the new product type.', 'error');
                    return;
                }
                formData.append('newProductType', newType);
            }
            
            formData.append('gstRate', productGstRateInput.value);
            formData.append('isActive', productIsActiveCheckbox.checked.toString()); 

            const dimensionElements = dimensionsContainer.querySelectorAll('.dimension-entry');
            let validDimensionsFound = false;
            dimensionElements.forEach((entry, index) => {
                const nameInput = entry.querySelector(`input[name^="dimensionName-"]`);
                const priceInput = entry.querySelector(`input[name^="basePrice-"]`);
                if (nameInput.value.trim() && priceInput.value.trim()) {
                    formData.append(`dimensions[${index}][dimensionName]`, nameInput.value);
                    formData.append(`dimensions[${index}][basePrice]`, priceInput.value);
                    validDimensionsFound = true;
                }
            });

            if (!validDimensionsFound) {
                 displayFeedback('Please add at least one complete dimension (name and price).', 'error');
                 return;
            }


            if (productBaseImageInput.files[0]) {
                formData.append('baseImage', productBaseImageInput.files[0]);
            } else if (editMode && existingBaseImageUrlInput.value) {
                formData.append('baseImageURL', existingBaseImageUrlInput.value);
            }


            if (productAdditionalImagesInput.files.length > 0) {
                for (let i = 0; i < productAdditionalImagesInput.files.length; i++) {
                    formData.append('additionalImages', productAdditionalImagesInput.files[i]);
                }
            }
            
            let url = `${BACKEND_URL}/api/admin/products`;
            let method = 'POST';

            if (editMode && productIdInput.value) {
                url = `${BACKEND_URL}/api/admin/products/${productIdInput.value}`;
                method = 'PUT';
            }
            console.log(`Submitting to ${url} with method ${method}`);


            try {
                const response = await fetch(url, {
                    method: method,
                    body: formData,
                });

                const result = await response.json();

                if (response.ok) {
                    displayFeedback(`Product ${editMode ? 'updated' : 'added'} successfully!`, 'success');
                    await fetchAndDisplayProducts(); 
                    showListView(); 
                    resetFormToCreateMode(); 
                } else {
                    let errorMsg = `Error: ${result.message || response.statusText}`;
                    if(result.errors) {
                        errorMsg += `\nDetails: ${Object.values(result.errors).map(e => e.message).join(', ')}`;
                    }
                    displayFeedback(errorMsg, 'error');
                }
            } catch (error) {
                console.error(`Error ${editMode ? 'updating' : 'adding'} product:`, error);
                displayFeedback('An unexpected error occurred. Please check console.', 'error');
            }
        });

        function renderAdminProductList(productsToRender) {
            const productListDiv = document.getElementById('existing-products-list');
            if (!productListDiv) return;

            if (productsToRender.length === 0) {
                productListDiv.innerHTML = '<p class="text-center text-zinc-400 col-span-full">No products found matching your criteria.</p>';
                return;
            }

            productListDiv.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6'; 
            productListDiv.innerHTML = ''; 

            productsToRender.forEach(product => {
                const card = document.createElement('div');
                card.className = 'admin-product-card'; 
                card.dataset.productId = product._id;

                const placeholderImage = `https://placehold.co/600x400/3f3f46/e4e4e7?text=${encodeURIComponent(product.name)}`;
                const displayGstRate = (typeof product.gstRate === 'number' ? product.gstRate : GST_RATE_DEFAULT) * 100;

                const allImages = [product.baseImageURL, ...(product.additionalImageURLs || [])].filter(url => url && typeof url === 'string' && url.trim() !== '');
                const initialImageSrc = allImages.length > 0 ? allImages[0] : placeholderImage;

                let imageCarouselHTML = `
                    <div class="admin-product-card-image-container">
                        <img src="${initialImageSrc}" alt="${product.name}" class="admin-product-card-image admin-product-image-${product._id}" onerror="this.onerror=null; this.src='${placeholderImage}';">
                `;
                if (allImages.length > 1) {
                    imageCarouselHTML += `
                        <button class="admin-carousel-arrow prev-arrow" data-product-id="${product._id}" data-direction="-1"><i class="fas fa-chevron-left"></i></button>
                        <button class="admin-carousel-arrow next-arrow" data-product-id="${product._id}" data-direction="1"><i class="fas fa-chevron-right"></i></button>
                    `;
                }
                imageCarouselHTML += `</div>`;
                
                let initialPriceText = "N/A";
                if (product.dimensions && product.dimensions.length > 0 && product.dimensions[0].basePrice !== undefined) {
                    initialPriceText = parseFloat(product.dimensions[0].basePrice).toFixed(2);
                }

                const statusButtonClass = product.isActive ? 'status-badge-active' : 'status-badge-inactive';
                const statusText = product.isActive ? 'Active' : 'Inactive';

                card.innerHTML = `
                    ${imageCarouselHTML}
                    <div class="admin-product-card-content">
                        <div>
                            <div class="flex justify-between items-start mb-1">
                                <h4 class="font-semibold text-lg text-zinc-100 truncate" title="${product.name}">${product.name}</h4>
                                <span class="status-badge ${statusButtonClass}">${statusText}</span>
                            </div>
                            <p class="text-sm text-zinc-400 mb-1">Type: ${product.productType}</p>
                            <p class="text-sm text-zinc-400 mb-1">Dimensions: ${product.dimensions ? product.dimensions.length : 0}</p>
                            <p class="text-sm text-zinc-300 font-medium">
                                Base Price: ${initialPriceText} Rs 
                                <span class="text-xs text-zinc-400">(+ ${displayGstRate.toFixed(0)}% GST)</span>
                            </p>
                        </div>
                        <div class="actions mt-4">
                            <button class="btn btn-warning btn-sm edit-product-btn flex-grow" data-id="${product._id}"><i class="fas fa-edit mr-1"></i> Edit</button>
                            <button class="btn btn-danger btn-sm delete-product-btn flex-grow" data-id="${product._id}"><i class="fas fa-trash mr-1"></i> Delete</button>
                        </div>
                    </div>
                `;
                productListDiv.appendChild(card);

                // Image Carousel Logic for Admin Cards
                if (allImages.length > 1) {
                    let currentImageIndex = 0;
                    const imgElement = card.querySelector(`.admin-product-image-${product._id}`);
                    const prevArrow = card.querySelector('.prev-arrow');
                    const nextArrow = card.querySelector('.next-arrow');

                    function updateAdminImage() {
                        if(imgElement) imgElement.src = allImages[currentImageIndex];
                        if(imgElement) imgElement.alt = `${product.name} - Image ${currentImageIndex + 1}`;
                    }

                    if(prevArrow) prevArrow.addEventListener('click', (e) => {
                        e.stopPropagation(); 
                        currentImageIndex = (currentImageIndex - 1 + allImages.length) % allImages.length;
                        updateAdminImage();
                    });
                    if(nextArrow) nextArrow.addEventListener('click', (e) => {
                        e.stopPropagation();
                        currentImageIndex = (currentImageIndex + 1) % allImages.length;
                        updateAdminImage();
                    });
                }
            });

            document.querySelectorAll('.edit-product-btn').forEach(button => {
                button.addEventListener('click', handleEditProduct);
            });
            document.querySelectorAll('.delete-product-btn').forEach(button => {
                button.addEventListener('click', handleDeleteProduct);
            });
        }


        function applyAdminFiltersAndSearch() {
            let filteredProducts = [...allAdminProducts];
            const searchTerm = adminProductSearchInput.value.toLowerCase().trim();
            
            const selectedTypes = [];
            const allAdminCheckbox = document.querySelector('.admin-product-type-filter[value="all"]');
            let allAdminProductsCheckboxChecked = allAdminCheckbox ? allAdminCheckbox.checked : true;

            adminProductTypeFilters.forEach(checkbox => {
                if (checkbox.checked && checkbox.value !== 'all') {
                    selectedTypes.push(checkbox.value.toLowerCase());
                }
            });

            const filterBySpecificTypes = selectedTypes.length > 0 && !allAdminProductsCheckboxChecked;

            if (filterBySpecificTypes) {
                filteredProducts = filteredProducts.filter(product => 
                    product.productType && selectedTypes.includes(product.productType.toLowerCase())
                );
            }

            if (searchTerm) {
                filteredProducts = filteredProducts.filter(product => 
                    product.name && product.name.toLowerCase().includes(searchTerm)
                );
            }
            renderAdminProductList(filteredProducts);
        }

        if(adminProductSearchInput) adminProductSearchInput.addEventListener('input', applyAdminFiltersAndSearch);
        
        adminProductTypeFilters.forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                const allAdminCheckbox = document.querySelector('.admin-product-type-filter[value="all"]');
                if (checkbox.value === 'all' && checkbox.checked) {
                    adminProductTypeFilters.forEach(cb => {
                        if (cb.value !== 'all') cb.checked = false;
                    });
                } else if (checkbox.value !== 'all' && checkbox.checked) {
                    if(allAdminCheckbox) allAdminCheckbox.checked = false;
                } else if (checkbox.value !== 'all' && !checkbox.checked) {
                    let anySpecificChecked = false;
                    adminProductTypeFilters.forEach(cb => {
                        if (cb.value !== 'all' && cb.checked) {
                            anySpecificChecked = true;
                        }
                    });
                    if (!anySpecificChecked && allAdminCheckbox) {
                        allAdminCheckbox.checked = true;
                    }
                }
                applyAdminFiltersAndSearch();
            });
        });

        if(adminFilterToggleButton && adminProductFilterOptionsContainer) { 
            adminFilterToggleButton.addEventListener('click', () => {
                adminProductFilterOptionsContainer.classList.toggle('hidden');
            });
        }


        async function fetchAndDisplayProducts() {
            existingProductsList.innerHTML = '<p class="text-center text-zinc-400 col-span-full">Loading products...</p>'; 
            try {
                const response = await fetch(`${BACKEND_URL}/api/admin/products`);
                if (!response.ok) {
                    let errorText = `HTTP error! status: ${response.status}`;
                    try {
                        const errorResult = await response.json();
                        errorText = errorResult.message || errorText;
                    } catch (e) { /* Ignore if response is not JSON */ }
                    throw new Error(errorText);
                }
                allAdminProducts = await response.json(); 
                applyAdminFiltersAndSearch(); 
                
            } catch (error) {
                console.error('Error fetching products:', error);
                existingProductsList.innerHTML = `<p class="text-center text-red-400 col-span-full">Error loading products: ${error.message}</p>`;
            }
        }

        function populateFormForEdit(product) { 
            formTitle.textContent = 'Edit Product';
            productIdInput.value = product._id;
            productNameInput.value = product.name || '';
            productDescriptionInput.value = product.description || '';
            
            const existingTypeOption = Array.from(productTypeSelect.options).find(opt => opt.value === product.productType);
            if (existingTypeOption) {
                productTypeSelect.value = product.productType;
                newProductTypeContainer.style.display = 'none';
                newProductTypeInput.required = false;
                newProductTypeInput.value = '';
            } else { 
                productTypeSelect.value = 'other';
                newProductTypeContainer.style.display = 'block';
                newProductTypeInput.value = product.productType || ''; 
                newProductTypeInput.required = true;
            }

            productGstRateInput.value = product.gstRate !== undefined ? product.gstRate : GST_RATE_DEFAULT;
            productIsActiveCheckbox.checked = product.isActive === undefined ? true : product.isActive;

            dimensionsContainer.innerHTML = ''; 
            if (product.dimensions && product.dimensions.length > 0) {
                product.dimensions.forEach(dim => addDimensionEntry(dim));
            } else {
                addDimensionEntry(); 
            }

            baseImagePreviewContainer.innerHTML = '';
            if (product.baseImageURL) {
                baseImagePreviewContainer.innerHTML = `<img src="${product.baseImageURL}" alt="Base Image" class="image-preview">`;
                existingBaseImageUrlInput.value = product.baseImageURL; 
            } else {
                 existingBaseImageUrlInput.value = '';
            }

            additionalImagesPreviewContainer.innerHTML = '';
            if (product.additionalImageURLs && product.additionalImageURLs.length > 0) {
                product.additionalImageURLs.forEach(url => {
                    additionalImagesPreviewContainer.innerHTML += `<img src="${url}" alt="Additional Image" class="image-preview">`;
                });
            }
            productBaseImageInput.value = '';
            productAdditionalImagesInput.value = '';


            submitProductBtn.textContent = 'Update Product';
            submitProductBtn.classList.remove('btn-primary');
            submitProductBtn.classList.add('btn-warning');
            cancelEditBtn.classList.remove('hidden'); 
            backToListBtn.classList.add('hidden'); 
            editMode = true;
            adminFeedback.textContent = '';
            adminFeedback.className = '';
        }


        async function handleEditProduct(event) { 
            const productId = event.currentTarget.dataset.id;
            displayFeedback('Loading product for editing...', 'info');
            try {
                const response = await fetch(`${BACKEND_URL}/api/admin/products/${productId}`);
                if (!response.ok) {
                    const errorResult = await response.json();
                    throw new Error(errorResult.message || `HTTP error! status: ${response.status}`);
                }
                const product = await response.json();
                showFormView(true, product); 
            } catch (error) {
                console.error('Error fetching product for edit:', error);
                displayFeedback(`Error loading product: ${error.message}`, 'error');
            }
        }

        async function handleDeleteProduct(event) {
            const productId = event.currentTarget.dataset.id;
            const productName = event.currentTarget.closest('.admin-product-card') ? 
                                event.currentTarget.closest('.admin-product-card').querySelector('h4').firstChild.textContent.trim() : 
                                'this product'; 
            
            if (!confirm(`Are you sure you want to delete the product "${productName}"?`)) {
                return;
            }

            displayFeedback('Deleting product...', 'info');

            try {
                const response = await fetch(`${BACKEND_URL}/api/admin/products/${productId}`, {
                    method: 'DELETE',
                });
                const result = await response.json();

                if (response.ok) {
                    displayFeedback(result.message || 'Product deleted successfully!', 'success');
                    fetchAndDisplayProducts(); 
                } else {
                    displayFeedback(`Error: ${result.message || response.statusText}`, 'error');
                }
            } catch (error) {
                console.error('Error deleting product:', error);
                displayFeedback('An unexpected error occurred while deleting. Please check console.', 'error');
            }
        }
        
        // Initial setup
        showListView(); 
        resetFormToCreateMode(); 
        fetchAndDisplayProducts(); 

    </script>
</body>
</html>
