<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gamma Ortho Instruments</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        html { scroll-behavior: smooth; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a202c; } /* Tailwind gray-900 */
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 10px; } /* Tailwind gray-600 */
        ::-webkit-scrollbar-thumb:hover { background: #718096; } /* Tailwind gray-500 */
        .nav-link-active { font-weight: 600; color: #ffffff; }
        .input-base-style, .product-quantity-input, .payment-input, .payment-select, .dimension-select, .category-select, .file-input, .country-code-select {
            padding: 0.75rem; /* p-3 */
            border-radius: 0.375rem; /* rounded-md */
            border: 1px solid #4b5563; /* gray-600 */
            background-color: #374151; /* gray-700 */
            color: #e5e7eb; /* gray-200 */
            width: 100%;
        }
        .product-quantity-input {
             width: 60px;
             padding: 0.5rem;
             text-align: center;
        }
        .country-code-select {
            width: auto; /* Adjust width for country code */
            padding-right: 2rem; /* Add some space for the dropdown arrow */
        }
        .dimension-select, .category-select {
            margin-bottom: 0.75rem; /* mb-3 */
        }
        .file-input {
            padding: 0.5rem; /* Adjust padding for file input */
        }
        .file-input::file-selector-button { /* Style the "Choose Files" button */
            font-weight: 500;
            color: #0ea5e9; /* sky-500 */
            background-color: #374151; /* gray-700 */
            border: none;
            padding: 0.5rem 0.75rem;
            margin-right: 0.75rem;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .file-input::file-selector-button:hover {
            background-color: #4b5563; /* gray-600 */
        }
        .payment-input::placeholder, .payment-select option, .dimension-select option, .category-select option, .country-code-select option { /* Retained for other inputs if needed */
            color: #9ca3af; /* gray-400 */
        }
        .order-item-action-button {
            background-color: #ef4444; /* red-500 */
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem; /* text-xs */
            line-height: 1rem;
        }
        .order-item-action-button:hover {
            background-color: #dc2626; /* red-600 */
        }
        #product-search-input { 
            flex-grow: 1; 
            padding-left: 1rem; /* px-4 equivalent */
            padding-right: 1rem; /* px-4 equivalent */
        }
        .product-price-display { 
            font-weight: bold;
            font-size: 1.125rem; /* text-lg */
            color: #38bdf8; /* sky-400 */
            margin-bottom: 0.75rem; /* mb-3 */
        }
        /* Styles for grouped order review */
        .order-product-group {
            background-color: #1f2937; /* gray-800 */
            padding: 1rem; /* p-4 */
            border-radius: 0.5rem; /* rounded-lg */
            margin-bottom: 0.75rem; /* mb-3 */
        }
        .order-variant-item {
            border-top: 1px solid #374151; /* gray-700 */
            padding-top: 0.5rem; /* pt-2 */
            margin-top: 0.5rem; /* mt-2 */
        }
        .order-variant-item:first-child {
            border-top: none;
            padding-top: 0;
            margin-top: 0;
        }
        /* Styles for product type filter */
        #product-filter-options-container { 
            margin-bottom: 1.5rem; 
            padding: 1rem; 
            background-color: #1f2937; 
            border-radius: 0.5rem; 
        }
        #product-filter-options-container h3 {
            font-size: 1.125rem; 
            font-weight: 600; 
            color: #e5e7eb; 
            margin-bottom: 0.75rem; 
        }
        .product-filter-options {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem; 
        }
        .product-filter-options label {
            display: flex;
            align-items: center;
            padding: 0.5rem 0.75rem; 
            background-color: #374151; 
            color: #d1d5db; 
            border-radius: 0.375rem; 
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .product-filter-options label:hover {
            background-color: #4b5563; 
        }
        .product-filter-options input[type="checkbox"] {
            margin-right: 0.5rem; 
            accent-color: #0ea5e9; 
        }
        #filter-toggle-button { 
            padding-top: 0.75rem;    /* py-3 */
            padding-bottom: 0.75rem; /* py-3 */
            padding-left: 0.75rem;   /* px-3 */
            padding-right: 0.75rem;  /* px-3 */
            background-color: #374151; 
            border: 1px solid #4b5563; 
            border-radius: 0.375rem; /* Match input */
        }
        #filter-toggle-button:hover {
            background-color: #4b5563; 
        }
        #contact-form-feedback {
            text-align: center;
            margin-top: 1rem;
            font-size: 0.875rem; /* text-sm */
        }
        .product-card-image { 
            width: 100%; 
            height: 22rem; 
            object-fit: contain; 
            padding: 1rem; 
            background-color: #374151; 
        }
    </style>
</head>
<body class="bg-black text-gray-200">

    <header class="bg-gray-900 shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="#" class="text-2xl font-bold text-sky-400">Gamma Ortho Instruments</a>
            <div class="space-x-4 hidden md:flex">
                <a href="#home" class="nav-link text-gray-300 hover:text-sky-400 px-3 py-2 rounded-md nav-link-active">Home</a>
                <a href="#products" class="nav-link text-gray-300 hover:text-sky-400 px-3 py-2 rounded-md">Products</a>
                <a href="#order-review" class="nav-link text-gray-300 hover:text-sky-400 px-3 py-2 rounded-md">Review Order</a>
                <a href="#about" class="nav-link text-gray-300 hover:text-sky-400 px-3 py-2 rounded-md">About Us</a>
                <a href="#contact" class="nav-link text-gray-300 hover:text-sky-400 px-3 py-2 rounded-md">Contact</a>
            </div>
            <div class="md:hidden">
                <button id="mobile-menu-button" class="text-gray-300 hover:text-sky-400 focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
            </div>
        </nav>
        <div id="mobile-menu" class="md:hidden hidden bg-gray-900 shadow-lg">
            <a href="#home" class="block nav-link text-gray-300 hover:text-sky-400 px-6 py-3 nav-link-active">Home</a>
            <a href="#products" class="block nav-link text-gray-300 hover:text-sky-400 px-6 py-3">Products</a>
            <a href="#order-review" class="block nav-link text-gray-300 hover:text-sky-400 px-6 py-3">Review Order</a>
            <a href="#about" class="block nav-link text-gray-300 hover:text-sky-400 px-6 py-3">About Us</a>
            <a href="#contact" class="block nav-link text-gray-300 hover:text-sky-400 px-6 py-3">Contact</a>
        </div>
    </header>

    <main>
        <section id="home" class="bg-gray-800 text-white py-20 md:py-32">
            <div class="container mx-auto px-6 text-center">
                <h1 class="text-4xl md:text-6xl font-bold mb-6 text-white">Gamma Orthopedic Instruments</h1>
                <p class="text-lg md:text-xl text-gray-300 mb-8 max-w-2xl mx-auto">
                    Delivering high-quality, reliable instruments for orthopedic surgeons and healthcare professionals.
                </p>
                <a href="#products" class="bg-sky-500 text-white font-semibold px-8 py-3 rounded-lg shadow-md hover:bg-sky-600 transition duration-300">
                    Explore Our Products
                </a>
            </div>
        </section>

        <section id="products" class="py-16 md:py-24 bg-black">
            <div class="container mx-auto px-6">
                <h2 class="text-3xl md:text-4xl font-bold text-center text-gray-100 mb-6">Our Products</h2>
                
                <div class="flex items-center gap-x-3 mb-6 max-w-xl mx-auto">
                    <button id="filter-toggle-button" class="text-gray-200 focus:outline-none focus:ring-2 focus:ring-sky-500">
                        <i class="fas fa-filter"></i>
                    </button>
                    <input type="text" id="product-search-input" placeholder="Search products by name..." class="input-base-style">
                </div>

                <div id="product-filter-options-container" class="product-filter-container max-w-3xl mx-auto hidden">
                    <h3>Filter by Product Type:</h3>
                    <div id="product-type-filter-options" class="product-filter-options">
                        <label><input type="checkbox" class="product-type-filter" value="all" checked> All Products</label>
                        <label><input type="checkbox" class="product-type-filter" value="wire-pin"> Wire and Pin</label>
                        <label><input type="checkbox" class="product-type-filter" value="ao-fixator"> A O-Fixator</label>
                        <label><input type="checkbox" class="product-type-filter" value="jess-fixator"> Jess Fixator</label>
                        <label><input type="checkbox" class="product-type-filter" value="ring-fixator"> Ring Fixator</label>
                        <label><input type="checkbox" class="product-type-filter" value="rail-fixator"> Rail Fixator</label>
                    </div>
                </div>
                
                <div id="product-list-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
                    <p id="products-loading-message" class="text-center text-gray-400 col-span-full">Loading products...</p>
                    {/* Product cards will be dynamically inserted here by JavaScript */}
                </div>
            </div>
        </section>

        <section id="order-review" class="py-16 md:py-24 bg-gray-800">
            <div class="container mx-auto px-6">
                <h2 class="text-3xl md:text-4xl font-bold text-center text-gray-100 mb-10">Review Order</h2>
                <div class="max-w-3xl mx-auto bg-gray-900 p-8 rounded-xl shadow-lg">
                    
                    <h3 class="text-2xl font-semibold text-gray-100 mb-4">Order Summary</h3>
                    <div id="order-items-container" class="mb-6 space-y-4"> 
                        <p class="text-gray-400 text-center">Your order is currently empty.</p>
                    </div>
                    <div class="border-t border-gray-700 pt-4 mb-2">
                        <p class="text-xl font-semibold text-right text-gray-100">Total (Incl. GST): <span id="order-total" class="text-sky-400">0 Rs</span></p>
                    </div>
                    <div class="text-right mb-6">
                         <button id="clear-order-btn" class="bg-yellow-600 text-white font-semibold px-4 py-2 rounded-lg shadow-md hover:bg-yellow-700 transition duration-300 text-sm">Clear Order</button>
                    </div>

                    <h3 class="text-xl font-semibold text-gray-100 mb-4 mt-8">Your Details:</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label for="customer-name" class="block text-gray-300 font-medium mb-2">Full Name <span class="text-red-500">*</span></label>
                            <input type="text" id="customer-name" class="input-base-style" placeholder="John Doe" required>
                        </div>
                        <div>
                            <label for="customer-email" class="block text-gray-300 font-medium mb-2">Email Address <span class="text-red-500">*</span></label>
                            <input type="email" id="customer-email" class="input-base-style" placeholder="you@example.com" required>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label for="customer-mobile" class="block text-gray-300 font-medium mb-2">Mobile Number <span class="text-red-500">*</span></label>
                            <div class="flex">
                                <select id="customer-mobile-code" class="country-code-select mr-2"></select>
                                <input type="tel" id="customer-mobile" class="input-base-style flex-grow" placeholder="9876543210" required>
                            </div>
                        </div>
                        <div>
                            <label for="customer-whatsapp" class="block text-gray-300 font-medium mb-2">WhatsApp Number (Optional)</label>
                             <div class="flex">
                                <select id="customer-whatsapp-code" class="country-code-select mr-2"></select>
                                <input type="tel" id="customer-whatsapp" class="input-base-style flex-grow" placeholder="9876543210">
                            </div>
                        </div>
                    </div>

                    <div class="mb-6">
                        <label for="customer-address" class="block text-gray-300 font-medium mb-2">Full Address <span class="text-red-500">*</span></label>
                        <textarea id="customer-address" rows="3" class="input-base-style" placeholder="Street, Area, Landmark" required></textarea>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                         <div>
                            <label for="customer-country" class="block text-gray-300 font-medium mb-2">Country <span class="text-red-500">*</span></label>
                            <select id="customer-country" class="input-base-style" required></select>
                        </div>
                        <div>
                            <label for="customer-state" class="block text-gray-300 font-medium mb-2">State <span class="text-red-500">*</span></label>
                            <select id="customer-state" class="input-base-style" required disabled></select>
                        </div>
                         <div>
                            <label for="customer-city" class="block text-gray-300 font-medium mb-2">City / District <span class="text-red-500">*</span></label>
                            <select id="customer-city" class="input-base-style" required disabled></select>
                        </div>
                    </div>
                     <div class="mb-6">
                        <label for="customer-pincode" class="block text-gray-300 font-medium mb-2">Pincode / Zip Code <span class="text-red-500">*</span></label>
                        <input type="text" id="customer-pincode" class="input-base-style" placeholder="e.g., 123456" required>
                    </div>

                    <div class="flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0 sm:space-x-3 mt-8">
                        <button id="clear-details-btn" class="w-full sm:w-auto bg-orange-600 text-white font-semibold px-4 py-3 rounded-lg shadow-md hover:bg-orange-700 transition duration-300">Clear Details</button>
                        <button id="place-order-btn" class="w-full sm:w-auto bg-green-600 text-white font-semibold px-4 py-3 rounded-lg shadow-md hover:bg-green-700 transition duration-300 flex-grow">Place Order</button>
                    </div>
                     <p id="order-feedback" class="text-center text-sm mt-4"></p>
                </div>
            </div>
        </section>

        <section id="about" class="py-16 md:py-24 bg-gray-900">
             <div class="container mx-auto px-6">
                <div class="max-w-4xl mx-auto text-center">
                    <h2 class="text-3xl md:text-4xl font-bold text-gray-100 mb-8">About Gamma Ortho Instruments</h2>
                    <p class="text-gray-300 leading-relaxed mb-6">
                        Gamma Ortho Instruments is dedicated to advancing orthopedic surgery through innovative and high-quality instruments. Our commitment to excellence ensures that every product we offer meets the highest standards of precision, durability, and reliability. Our mission is to empower healthcare professionals with the tools they need to achieve optimal patient outcomes.
                    </p>
                    <p class="text-gray-300 leading-relaxed">GSTN: 24ABCFG6367R1ZR</p>
                    </div>
            </div>
        </section>

        <section id="contact" class="py-16 md:py-24 bg-black">
            <div class="container mx-auto px-6">
                 <h2 class="text-3xl md:text-4xl font-bold text-center text-gray-100 mb-12">For Inquiry, contact us</h2>
                <div class="max-w-2xl mx-auto bg-gray-800 p-8 rounded-xl shadow-lg">
                    <form id="inquiry-form"> 
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label for="contact-name" class="block text-gray-300 font-medium mb-2">Full Name</label>
                                <input type="text" id="contact-name" name="contact-name" class="input-base-style" placeholder="John Doe" required>
                            </div>
                            <div>
                                <label for="contact-email" class="block text-gray-300 font-medium mb-2">Email Address</label>
                                <input type="email" id="contact-email" name="contact-email" class="input-base-style" placeholder="you@example.com" required>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label for="contact-mobile" class="block text-gray-300 font-medium mb-2">Mobile Number</label>
                                <input type="tel" id="contact-mobile" name="contact-mobile" class="input-base-style" placeholder="+91-9876543210" required>
                            </div>
                            <div>
                                <label for="contact-whatsapp" class="block text-gray-300 font-medium mb-2">WhatsApp Number (Optional)</label>
                                <input type="tel" id="contact-whatsapp" name="contact-whatsapp" class="input-base-style" placeholder="+91-9876543210">
                            </div>
                        </div>
                        <div class="mb-6">
                            <label for="contact-hospital" class="block text-gray-300 font-medium mb-2">Hospital/Clinic (Optional)</label>
                            <input type="text" id="contact-hospital" name="contact-hospital" class="input-base-style" placeholder="City General Hospital">
                        </div>
                        <div class="mb-6">
                            <label for="contact-category" class="block text-gray-300 font-medium mb-2">Category</label>
                            <select id="contact-category" name="contact-category" class="category-select input-base-style" required>
                                <option value="">-- Select Category --</option>
                                <option value="product_related">Product Related</option>
                                <option value="payment_related">Payment Related</option>
                                <option value="delivery_related">Delivery Related</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="mb-6">
                            <label for="contact-message" class="block text-gray-300 font-medium mb-2">Message</label>
                            <textarea id="contact-message" name="contact-message" rows="5" class="input-base-style" placeholder="Your inquiry or message..." required></textarea>
                        </div>
                        <div class="mb-6">
                            <label for="contact-files" class="block text-gray-300 font-medium mb-2">Attach Files (Optional)</label>
                            <input type="file" id="contact-files" name="contact-files[]" class="file-input input-base-style" multiple>
                            <p class="text-xs text-gray-400 mt-1">You can select multiple files. Max 5MB each.</p>
                        </div>
                        <div class="text-center">
                            <button type="submit" class="bg-sky-600 text-white font-semibold px-8 py-3 rounded-lg shadow-md hover:bg-sky-700 transition duration-300 w-full md:w-auto">
                                Send Inquiry
                            </button>
                        </div>
                    </form>
                    <p id="contact-form-feedback" class="contact-form-feedback"></p>
                    <div class="mt-10 text-center text-gray-300">
                        <p class="text-lg font-medium">Or reach us directly:</p>
                        <p class="mt-2"><i class="fas fa-phone-alt mr-2 text-sky-400"></i> +91-99986 00047</p>
                        <p class="mt-1"><a href="https://wa.me/919998600047" target="_blank" class="hover:text-sky-300"><i class="fab fa-whatsapp mr-2 text-sky-400"></i> +91-99986 00047</a></p>
                        <p class="mt-1"><i class="fas fa-envelope mr-2 text-sky-400"></i> amit_chhatrala@yahoo.com</p>
                        <p class="mt-1"><i class="fas fa-map-marker-alt mr-2 text-sky-400"></i> Plot No. 17, Bhumi Industrial Area - 2, Anand Liner Gate, Veraval - Shapar, Rajkot - 360 024 (Gujarat) India</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="bg-gray-900 text-gray-400 py-12">
        <div class="container mx-auto px-6 text-center">
            <p>&copy; <span id="currentYear"></span> Gamma Ortho Instruments. All rights reserved.</p>
            <p class="text-sm mt-2">Designed with care for the medical community.</p>
        </div>
    </footer>

    <script>
        // Global constants for GST rate and backend API URL
        const GST_RATE = 0.12; 
        const BACKEND_URL = 'https://gamma-ortho.onrender.com'; 

        // Global array to store all products fetched from the backend
        let allFetchedProducts = []; 
        // Global array to store items currently in the customer's order
        let currentOrder = []; 

        // Predefined country codes for phone number input
        const countryCodes = [ { name: "IND", code: "+91" }, { name: "USA", code: "+1" }, { name: "UK", code: "+44" }];
        // Location data for populating country, state, and city dropdowns
        const locationData = {
            "India": { /* States and cities for India */
                "Andhra Pradesh": ["Visakhapatnam", "Vijayawada", "Guntur", "Nellore", "Kurnool"],
                "Arunachal Pradesh": ["Itanagar", "Naharlagun", "Pasighat"],
                "Assam": ["Guwahati", "Dibrugarh", "Silchar", "Jorhat"],
                "Bihar": ["Patna", "Gaya", "Bhagalpur", "Muzaffarpur"],
                "Chhattisgarh": ["Raipur", "Bhilai", "Korba", "Bilaspur"],
                "Goa": ["Panaji", "Margao", "Vasco da Gama"],
                "Gujarat": ["Ahmedabad", "Surat", "Vadodara", "Rajkot", "Bhavnagar", "Jamnagar", "Junagadh", "Gandhinagar", "Anand", "Mehsana"],
                "Haryana": ["Faridabad", "Gurugram", "Panipat", "Ambala", "Yamunanagar", "Rohtak", "Hisar"],
                "Himachal Pradesh": ["Shimla", "Solan", "Dharamshala", "Kullu", "Mandi", "Palampur"],
                "Jharkhand": ["Ranchi", "Jamshedpur", "Dhanbad", "Bokaro Steel City", "Deoghar"],
                "Karnataka": ["Bengaluru", "Hubballi-Dharwad", "Mysuru", "Mangaluru", "Belagavi", "Davanagere", "Ballari"],
                "Kerala": ["Thiruvananthapuram", "Kochi", "Kozhikode", "Thrissur", "Kollam", "Alappuzha"],
                "Madhya Pradesh": ["Indore", "Bhopal", "Jabalpur", "Gwalior", "Ujjain", "Sagar", "Rewa"],
                "Maharashtra": ["Mumbai", "Pune", "Nagpur", "Thane", "Nashik", "Aurangabad", "Solapur", "Amravati", "Navi Mumbai"],
                "Manipur": ["Imphal", "Thoubal", "Bishnupur", "Churachandpur"],
                "Meghalaya": ["Shillong", "Tura", "Nongstoin", "Jowai"],
                "Mizoram": ["Aizawl", "Lunglei", "Saiha", "Champhai"],
                "Nagaland": ["Kohima", "Dimapur", "Mokokchung", "Tuensang"],
                "Odisha": ["Bhubaneswar", "Cuttack", "Rourkela", "Puri", "Sambalpur", "Berhampur"],
                "Punjab": ["Ludhiana", "Amritsar", "Jalandhar", "Patiala", "Bathinda", "Mohali"],
                "Rajasthan": ["Jaipur", "Jodhpur", "Kota", "Bikaner", "Udaipur", "Ajmer", "Alwar"],
                "Sikkim": ["Gangtok", "Namchi", "Mangan", "Geyzing"],
                "Tamil Nadu": ["Chennai", "Coimbatore", "Madurai", "Tiruchirappalli", "Salem", "Tirunelveli", "Erode"],
                "Telangana": ["Hyderabad", "Warangal", "Nizamabad", "Karimnagar", "Ramagundam", "Khammam"],
                "Tripura": ["Agartala", "Udaipur (Tripura)", "Dharmanagar", "Kailasahar"],
                "Uttar Pradesh": ["Lucknow", "Kanpur", "Ghaziabad", "Agra", "Meerut", "Varanasi", "Prayagraj", "Noida", "Bareilly"],
                "Uttarakhand": ["Dehradun", "Haridwar", "Roorkee", "Haldwani", "Rudrapur", "Kashipur"],
                "West Bengal": ["Kolkata", "Howrah", "Asansol", "Siliguri", "Durgapur", "Bardhaman", "Malda"],
                "Andaman and Nicobar Islands": ["Port Blair", "Car Nicobar", "Mayabunder"],
                "Chandigarh": ["Chandigarh"],
                "Dadra and Nagar Haveli and Daman and Diu": ["Daman", "Silvassa", "Diu"],
                "Lakshadweep": ["Kavaratti", "Agatti", "Amini", "Andrott"],
                "Delhi (National Capital Territory)": ["New Delhi", "North Delhi", "South Delhi", "East Delhi", "West Delhi", "Central Delhi"],
                "Puducherry": ["Puducherry", "Karaikal", "Yanam", "Mahe"],
                "Ladakh": ["Leh", "Kargil"],
                "Jammu and Kashmir": ["Srinagar", "Jammu", "Anantnag", "Baramulla", "Udhampur"]
            },
            "USA": { /* States and cities for USA */
                "California": ["Los Angeles", "San Francisco", "San Diego", "Sacramento", "Oakland", "Fresno", "Long Beach"],
                "New York": ["New York City", "Buffalo", "Rochester", "Albany", "Syracuse", "Yonkers"],
                "Texas": ["Houston", "Dallas", "Austin", "San Antonio", "Fort Worth", "El Paso"]
            },
            "UK": { /* Regions and cities for UK */
                "England": ["London", "Manchester", "Birmingham", "Liverpool", "Bristol", "Leeds", "Sheffield"],
                "Scotland": ["Edinburgh", "Glasgow", "Aberdeen", "Dundee"],
                "Wales": ["Cardiff", "Swansea", "Newport"]
            }
        };

        // DOM Element references, fetched once for efficiency
        const productListContainer = document.getElementById('product-list-container');
        const productsLoadingMessage = document.getElementById('products-loading-message');
        const orderItemsContainer = document.getElementById('order-items-container');
        const orderTotalElement = document.getElementById('order-total');
        const placeOrderBtn = document.getElementById('place-order-btn');
        const clearOrderBtn = document.getElementById('clear-order-btn');
        const orderFeedback = document.getElementById('order-feedback');
        const clearDetailsBtn = document.getElementById('clear-details-btn');
        const countrySelect = document.getElementById('customer-country');
        const stateSelect = document.getElementById('customer-state');
        const citySelect = document.getElementById('customer-city'); 
        const productSearchInput = document.getElementById('product-search-input');
        const productTypeFilters = document.querySelectorAll('.product-type-filter');
        const filterToggleButton = document.getElementById('filter-toggle-button');
        const filterOptionsContainer = document.getElementById('product-filter-options-container');
        const inquiryForm = document.getElementById('inquiry-form');
        const contactFormFeedback = document.getElementById('contact-form-feedback');
        const menuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        const currentYearEl = document.getElementById('currentYear');
        const customerNameInput = document.getElementById('customer-name');
        const customerEmailInput = document.getElementById('customer-email');
        const customerMobileCodeInput = document.getElementById('customer-mobile-code');
        const customerMobileInput = document.getElementById('customer-mobile');
        const customerWhatsappCodeInput = document.getElementById('customer-whatsapp-code');
        const customerWhatsappInput = document.getElementById('customer-whatsapp');
        const customerAddressInput = document.getElementById('customer-address');
        const customerPincodeInput = document.getElementById('customer-pincode');


        /**
         * Populates the dimension dropdown and initial price for a product card.
         * @param {HTMLElement} cardElement - The product card's root DOM element.
         * @param {Array} dimensions - Array of dimension objects for the product.
         * @param {string} productId - The unique ID of the product.
         */
        function populateDimensionDropdownsOnCard(cardElement, dimensions, productId) {
            const selectElement = cardElement.querySelector(`#dim-${productId}`);
            const priceDisplayElement = cardElement.querySelector(`#price-display-${productId}`);
            const gstRateTextElements = cardElement.querySelectorAll('.gst-rate-text'); 

            if (!selectElement || !priceDisplayElement) {
                console.warn(`Missing select or price display for product ${productId} on card.`);
                if(priceDisplayElement) priceDisplayElement.textContent = "N/A";
                return;
            }

            if (!dimensions || dimensions.length === 0) {
                selectElement.innerHTML = '<option value="">N/A</option>';
                selectElement.disabled = true;
                priceDisplayElement.textContent = "N/A";
                if (gstRateTextElements.length > 0) gstRateTextElements.forEach(el => el.textContent = 'N/A');
                return;
            }
            
            selectElement.disabled = false; 
            const productData = allFetchedProducts.find(p => p._id === productId);
            const currentProductGst = (productData && typeof productData.gstRate === 'number') ? productData.gstRate : GST_RATE;
            gstRateTextElements.forEach(el => el.textContent = (currentProductGst * 100).toFixed(0));
            
            selectElement.innerHTML = ''; 

            dimensions.forEach((dim, index) => {
                const option = document.createElement('option');
                option.value = dim.dimensionName;
                option.textContent = dim.dimensionName;
                option.dataset.basePrice = dim.basePrice; 
                selectElement.appendChild(option);

                if (index === 0) {
                    priceDisplayElement.textContent = parseFloat(dim.basePrice).toFixed(2);
                }
            });

            selectElement.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const basePrice = parseFloat(selectedOption.dataset.basePrice);
                priceDisplayElement.textContent = basePrice.toFixed(2);
            });
        }
        
        /**
         * Renders product cards into the product list container.
         * @param {Array} productsToRender - Array of product objects to display.
         */
        function renderProducts(productsToRender) {
            if (!productListContainer) {
                console.error("Product list container not found for rendering products!");
                return;
            }
            productListContainer.innerHTML = ''; 
            
            if (!productsToRender || productsToRender.length === 0) {
                productListContainer.innerHTML = '<p class="text-center text-gray-400 col-span-full">No products found matching your criteria.</p>';
                return;
            }

            productsToRender.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card bg-gray-800 rounded-xl shadow-lg overflow-hidden transform hover:scale-105 transition-transform duration-300';
                card.dataset.productId = product._id; 
                card.dataset.productName = product.name.toLowerCase(); 
                card.dataset.productType = product.productType ? product.productType.toLowerCase() : 'unknown'; 

                let initialBasePrice = "N/A";
                if (product.dimensions && product.dimensions.length > 0 && product.dimensions[0].basePrice !== undefined) {
                    initialBasePrice = parseFloat(product.dimensions[0].basePrice).toFixed(2);
                }
                
                const placeholderImage = `https://placehold.co/600x400/4A5568/E2E8F0?text=${encodeURIComponent(product.name)}`;
                const displayGstRate = (typeof product.gstRate === 'number' ? product.gstRate : GST_RATE) * 100;

                card.innerHTML = `
                    <img src="${product.baseImageURL || placeholderImage}" alt="${product.name}" class="product-card-image" onerror="this.onerror=null; this.src='${placeholderImage}';">
                    <div class="p-6">
                        <h3 class="text-xl font-semibold text-gray-100 mb-2 product-name">${product.name}</h3>
                        <p class="product-price-display">Price: <span id="price-display-${product._id}">${initialBasePrice}</span> Rs + <span class="gst-rate-text">${displayGstRate.toFixed(0)}</span>% GST</p>
                        <div class="mb-3">
                            <label for="dim-${product._id}" class="block text-sm font-medium text-gray-300 mb-1">Select Dimension:</label>
                            <select id="dim-${product._id}" class="dimension-select"></select>
                        </div>
                        <div class="flex items-center space-x-3">
                            <label for="qty-${product._id}" class="text-sm text-gray-300">Qty:</label>
                            <input type="number" id="qty-${product._id}" min="1" value="1" class="product-quantity-input">
                            <button class="add-to-order-btn inline-block bg-sky-500 text-white px-4 py-2 rounded-lg hover:bg-sky-600 transition duration-300 text-sm flex-grow">Add to cart</button>
                        </div>
                    </div>
                `;
                productListContainer.appendChild(card);
                populateDimensionDropdownsOnCard(card, product.dimensions, product._id); 

                const addToOrderButton = card.querySelector('.add-to-order-btn');
                if (addToOrderButton) {
                    addToOrderButton.addEventListener('click', () => {
                        console.log('Add to cart clicked for product:', product.name, product._id); 

                        const quantityInput = card.querySelector(`#qty-${product._id}`);
                        const dimensionSelect = card.querySelector(`#dim-${product._id}`);
                        const quantity = parseInt(quantityInput.value);
                        const selectedDimensionName = dimensionSelect.value;
                        
                        console.log('Selected dimension name:', selectedDimensionName, 'Quantity:', quantity); 

                        if (!selectedDimensionName) {
                            if(orderFeedback) {
                                orderFeedback.textContent = 'Please select a dimension for the product.';
                                orderFeedback.className = 'text-center text-sm mt-4 text-red-500';
                                setTimeout(() => { if(orderFeedback) orderFeedback.textContent = ''; }, 3000);
                            }
                            return;
                        }

                        const fullProductData = allFetchedProducts.find(p => p._id === product._id);
                        if (!fullProductData || !fullProductData.dimensions) {
                            console.error("Could not find full product data or dimensions for ID:", product._id, "Full data:", fullProductData);
                            if(orderFeedback) {
                                orderFeedback.textContent = 'Error finding product details. Please refresh.';
                                orderFeedback.className = 'text-center text-sm mt-4 text-red-500';
                                setTimeout(() => { if(orderFeedback) orderFeedback.textContent = ''; }, 3000);
                            }
                            return;
                        }

                        const selectedDimensionData = fullProductData.dimensions.find(d => d.dimensionName === selectedDimensionName);
                        console.log('Found dimension data:', selectedDimensionData); 
                        
                        const productGstRate = (typeof fullProductData.gstRate === 'number') ? fullProductData.gstRate : GST_RATE;
                        console.log('Product GST rate to be used for order item:', productGstRate); 

                        if (quantity > 0 && selectedDimensionData) { 
                            addItemToOrder(product._id, product.name, selectedDimensionName, quantity, selectedDimensionData.basePrice, productGstRate);
                            if(quantityInput) quantityInput.value = '1'; 
                        } else {
                            let errorMsg = 'Please enter a valid quantity.';
                            if (!selectedDimensionData) {
                                errorMsg = 'Could not find data for the selected dimension.';
                            }
                            if(orderFeedback) {
                                orderFeedback.textContent = errorMsg;
                                orderFeedback.className = 'text-center text-sm mt-4 text-red-500';
                            }
                            console.error("Add to cart error:", errorMsg, "Selected Dim Data:", selectedDimensionData, "GST Rate:", productGstRate);
                            setTimeout(() => { if(orderFeedback) orderFeedback.textContent = ''; }, 3000);
                        }
                    });
                }
            });
        }

        /**
         * Fetches products from the backend API and triggers rendering.
         */
        async function fetchAndDisplayCustomerProducts() {
            if (productsLoadingMessage) productsLoadingMessage.classList.remove('hidden');
            try {
                console.log(`Fetching products from: ${BACKEND_URL}/api/products`);
                const response = await fetch(`${BACKEND_URL}/api/products`);
                console.log(`Response status from /api/products: ${response.status}`);
                if (!response.ok) { 
                    let errorText = `HTTP error! status: ${response.status}`;
                    try {
                        const errorResult = await response.json(); 
                        errorText = errorResult.message || errorText;
                        console.error("Error fetching products (JSON):", errorResult);
                    } catch (e) { 
                        errorText = await response.text(); 
                        console.error("Error fetching products (text):", errorText);
                    }
                    throw new Error(errorText);
                }
                allFetchedProducts = await response.json(); 
                console.log("Fetched products:", allFetchedProducts);
                if (productsLoadingMessage) productsLoadingMessage.classList.add('hidden');
                applyFiltersAndSearch(); 
            } catch (error) {
                console.error('Error fetching products for customer site:', error);
                if (productsLoadingMessage) productsLoadingMessage.classList.add('hidden');
                if(productListContainer) productListContainer.innerHTML = `<p class="text-center text-red-500 col-span-full">Error loading products. ${error.message}. Please check console for details.</p>`;
            }
        }

        /**
         * Populates country code dropdowns for mobile and WhatsApp numbers.
         */
        function populateCountryCodeDropdowns() { 
            const mobileCodeSelect = document.getElementById('customer-mobile-code');
            const whatsappCodeSelect = document.getElementById('customer-whatsapp-code');
            
            if(mobileCodeSelect) {
                countryCodes.forEach(country => {
                    const option = document.createElement('option');
                    option.value = country.code;
                    option.textContent = `${country.name} (${country.code})`;
                    if (country.name === "IND") option.selected = true; 
                    mobileCodeSelect.appendChild(option);
                });
            }
            if(whatsappCodeSelect) {
                 countryCodes.forEach(country => {
                    const option = document.createElement('option');
                    option.value = country.code;
                    option.textContent = `${country.name} (${country.code})`;
                     if (country.name === "IND") option.selected = true; 
                    whatsappCodeSelect.appendChild(option.cloneNode(true)); 
                });
            }
        }
        
        /**
         * Populates the country dropdown in the customer details form.
         */
        function populateCountries() { 
            if (!countrySelect) return;
            countrySelect.innerHTML = '<option value="">-- Select Country --</option>';
            for (const country in locationData) {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                countrySelect.appendChild(option);
            }
            if (locationData.hasOwnProperty("India")) {
                countrySelect.value = "India";
                populateStates("India"); 
            }
        }

        /**
         * Populates the state dropdown based on the selected country.
         * @param {string} country - The selected country name.
         */
        function populateStates(country) { 
            if (!stateSelect || !citySelect || !locationData[country]) {
                if(stateSelect) {
                    stateSelect.innerHTML = '<option value="">-- Select State --</option>';
                    stateSelect.disabled = true;
                }
                if(citySelect) {
                    citySelect.innerHTML = '<option value="">-- Select City --</option>';
                    citySelect.disabled = true;
                }
                return;
            }
            stateSelect.innerHTML = '<option value="">-- Select State --</option>';
            stateSelect.disabled = false;
            citySelect.innerHTML = '<option value="">-- Select City --</option>';
            citySelect.disabled = true; 

            for (const state in locationData[country]) {
                const option = document.createElement('option');
                option.value = state;
                option.textContent = state;
                stateSelect.appendChild(option);
            }
        }

        /**
         * Populates the city dropdown based on the selected country and state.
         * @param {string} country - The selected country name.
         * @param {string} state - The selected state name.
         */
        function populateCities(country, state) { 
            if (!citySelect || !locationData[country] || !locationData[country][state]) {
                 if(citySelect) {
                    citySelect.innerHTML = '<option value="">-- Select City --</option>';
                    citySelect.disabled = true;
                }
                return;
            }
            citySelect.innerHTML = '<option value="">-- Select City --</option>';
            citySelect.disabled = false;
            locationData[country][state].forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                citySelect.appendChild(option);
            });
        }
        
        if (countrySelect) countrySelect.addEventListener('change', function() { populateStates(this.value); });
        if (stateSelect) stateSelect.addEventListener('change', function() { if (countrySelect) { populateCities(countrySelect.value, this.value); }});

        if(filterToggleButton && filterOptionsContainer) {
            filterToggleButton.addEventListener('click', () => {
                filterOptionsContainer.classList.toggle('hidden');
            });
        }

        /**
         * Applies search term and product type filters to the product list.
         */
        function applyFiltersAndSearch() {
            let filteredProducts = [...allFetchedProducts]; 
            const searchTerm = productSearchInput ? productSearchInput.value.toLowerCase().trim() : "";
            
            const selectedTypes = [];
            let allProductsCheckboxChecked = true; 
            const allCheckbox = document.querySelector('.product-type-filter[value="all"]');
            if (allCheckbox) {
                allProductsCheckboxChecked = allCheckbox.checked;
            }

            productTypeFilters.forEach(checkbox => {
                if (checkbox.checked && checkbox.value !== 'all') {
                    selectedTypes.push(checkbox.value.toLowerCase()); 
                }
            });

            const showAllCategories = allProductsCheckboxChecked || selectedTypes.length === 0;
            
            if (!showAllCategories && selectedTypes.length > 0) {
                filteredProducts = filteredProducts.filter(product => 
                    product.productType && selectedTypes.includes(product.productType.toLowerCase())
                );
            }

            if (searchTerm) {
                filteredProducts = filteredProducts.filter(product => 
                    product.name && product.name.toLowerCase().includes(searchTerm)
                );
            }
            renderProducts(filteredProducts); 
        }

        if(productSearchInput) productSearchInput.addEventListener('input', applyFiltersAndSearch);
        
        productTypeFilters.forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                if (checkbox.value === 'all' && checkbox.checked) {
                    productTypeFilters.forEach(cb => {
                        if (cb.value !== 'all') cb.checked = false;
                    });
                } else if (checkbox.value !== 'all' && checkbox.checked) {
                    const allCheckbox = document.querySelector('.product-type-filter[value="all"]');
                    if(allCheckbox) allCheckbox.checked = false;
                }
                applyFiltersAndSearch(); 
            });
        });
        
        /**
         * Renders the current order summary in the "Review Order" section.
         */
        function renderOrderSummary() {
            console.log("renderOrderSummary called. currentOrder:", JSON.parse(JSON.stringify(currentOrder))); 
            if (!orderItemsContainer || !orderTotalElement || !placeOrderBtn || !clearOrderBtn) {
                console.error("One or more order summary DOM elements not found for renderOrderSummary!");
                return;
            }
            orderItemsContainer.innerHTML = ''; 
            
            if (currentOrder.length === 0) {
                orderItemsContainer.innerHTML = '<p class="text-gray-400 text-center">Your order is currently empty.</p>';
                orderTotalElement.textContent = '0.00 Rs';
                placeOrderBtn.disabled = true;
                placeOrderBtn.classList.add('opacity-50', 'cursor-not-allowed');
                clearOrderBtn.disabled = true; 
                clearOrderBtn.classList.add('opacity-50', 'cursor-not-allowed');
                return;
            }
            placeOrderBtn.disabled = false;
            placeOrderBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            clearOrderBtn.disabled = false; 
            clearOrderBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            
            let grandTotal = 0;
            const mainUl = document.createElement('ul'); 
            mainUl.className = 'space-y-3'; 

            currentOrder.forEach(productGroup => {
                const productLi = document.createElement('li');
                productLi.className = 'order-product-group'; 

                const productNameHeader = document.createElement('h4');
                productNameHeader.className = 'text-lg font-semibold text-gray-100 mb-2';
                productNameHeader.textContent = productGroup.baseProductName;
                productLi.appendChild(productNameHeader);

                const variantsUl = document.createElement('ul'); 
                variantsUl.className = 'space-y-2 pl-1'; 

                productGroup.variants.forEach(variant => {
                    const variantLi = document.createElement('li');
                    variantLi.className = 'order-variant-item flex justify-between items-center text-sm';
                    
                    const baseSubtotalForVariant = variant.basePrice * variant.quantity;
                    const gstForVariantSubtotal = baseSubtotalForVariant * variant.gstRate;
                    const variantTotalWithGst = variant.priceIncGst * variant.quantity; 
                    grandTotal += variantTotalWithGst; 

                    variantLi.innerHTML = `
                        <div>
                            <span class="text-gray-300">${variant.dimension}</span>
                            <span class="text-xs text-gray-500 block">Qty: ${variant.quantity}</span>
                            <span class="text-xs text-gray-500 block">
                                Amount: ${baseSubtotalForVariant.toFixed(2)} Rs + GST: ${gstForVariantSubtotal.toFixed(2)} Rs
                            </span>
                        </div>
                        <div class="flex items-center">
                            <span class="text-gray-200 mr-3">${variantTotalWithGst.toFixed(2)} Rs</span>
                            <button class="remove-item-btn order-item-action-button" data-variant-id="${variant.variantId}" title="Remove item">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                    variantsUl.appendChild(variantLi);
                });
                productLi.appendChild(variantsUl);
                mainUl.appendChild(productLi);
            });

            orderItemsContainer.appendChild(mainUl);
            orderTotalElement.textContent = `${grandTotal.toFixed(2)} Rs`; 
            console.log("Order summary rendered. Grand total:", grandTotal.toFixed(2)); 
        }

        /**
         * Adds an item (product variant) to the current order.
         */
        function addItemToOrder(baseProductId, baseProductName, selectedDimensionName, quantity, basePrice, gstRate) { 
            console.log('addItemToOrder called with:', {baseProductId, baseProductName, selectedDimensionName, quantity, basePrice, gstRate}); 
            
            const effectiveGstRate = (typeof gstRate === 'number' && !isNaN(gstRate)) ? gstRate : GST_RATE;
            console.log('Effective GST Rate used for this item:', effectiveGstRate);

            const priceIncGst = parseFloat(basePrice) * (1 + effectiveGstRate); 
            const variantId = `${baseProductId}-${selectedDimensionName.replace(/\s+/g, '-')}`; 

            let productGroup = currentOrder.find(pg => pg.baseProductId === baseProductId);

            if (productGroup) { 
                let variant = productGroup.variants.find(v => v.variantId === variantId);
                if (variant) { 
                    variant.quantity += quantity;
                     console.log("Updated quantity for existing variant:", variantId, "New Qty:", variant.quantity); 
                } else { 
                    productGroup.variants.push({ 
                        variantId: variantId,
                        dimension: selectedDimensionName,
                        basePrice: parseFloat(basePrice),
                        gstRate: effectiveGstRate, 
                        priceIncGst: priceIncGst, 
                        quantity: quantity 
                    });
                    console.log("Added new variant to existing product group:", variantId); 
                }
            } else { 
                currentOrder.push({
                    baseProductId: baseProductId,
                    baseProductName: baseProductName,
                    variants: [{
                        variantId: variantId,
                        dimension: selectedDimensionName,
                        basePrice: parseFloat(basePrice),
                        gstRate: effectiveGstRate, 
                        priceIncGst: priceIncGst, 
                        quantity: quantity 
                    }]
                });
                console.log("Added new product group with variant:", baseProductId, variantId); 
            }
            
            if(orderFeedback) {
                orderFeedback.textContent = `Added ${quantity} x ${baseProductName} (${selectedDimensionName}) to your cart.`;
                orderFeedback.className = 'text-center text-sm mt-4 text-green-500';
                setTimeout(() => { if(orderFeedback) orderFeedback.textContent = ''; }, 3000);
            }
            renderOrderSummary(); 
        }
        
        /**
         * Removes an item (product variant) from the current order.
         */
        function removeItemFromOrder(variantIdToRemove) {
            console.log("removeItemFromOrder called for variantId:", variantIdToRemove); 
            let productGroupIndex = -1;
            let variantIndexToRemove = -1;

            for (let i = 0; i < currentOrder.length; i++) {
                variantIndexToRemove = currentOrder[i].variants.findIndex(v => v.variantId === variantIdToRemove);
                if (variantIndexToRemove > -1) {
                    productGroupIndex = i;
                    break;
                }
            }
            console.log(`Found productGroupIndex: ${productGroupIndex}, variantIndexToRemove: ${variantIndexToRemove}`); 

            if (productGroupIndex > -1 && variantIndexToRemove > -1) {
                const removedItemName = `${currentOrder[productGroupIndex].baseProductName} (${currentOrder[productGroupIndex].variants[variantIndexToRemove].dimension})`;
                currentOrder[productGroupIndex].variants.splice(variantIndexToRemove, 1);
                console.log("Variant removed. Variants left in group:", currentOrder[productGroupIndex].variants.length); 

                if (currentOrder[productGroupIndex].variants.length === 0) {
                    currentOrder.splice(productGroupIndex, 1);
                    console.log("Product group removed as it's empty."); 
                }
                
                if(orderFeedback) {
                    orderFeedback.textContent = `Removed ${removedItemName} from your order.`;
                    orderFeedback.className = 'text-center text-sm mt-4 text-red-500';
                    setTimeout(() => { if(orderFeedback) orderFeedback.textContent = ''; }, 3000);
                }
            } else {
                 console.warn("Could not find item to remove with variantId:", variantIdToRemove); 
            }
            renderOrderSummary(); 
        }

        if(orderItemsContainer) orderItemsContainer.addEventListener('click', (event) => {
            const removeButton = event.target.closest('.remove-item-btn');
            if (removeButton) {
                const variantId = removeButton.dataset.variantId;
                console.log("Remove button clicked for variantId:", variantId); 
                removeItemFromOrder(variantId);
            }
        });

        if(placeOrderBtn) {
            placeOrderBtn.addEventListener('click', async () => { 
                console.log("Place Order button clicked.");
                if(orderFeedback) orderFeedback.textContent = ''; 

                const customerName = customerNameInput ? customerNameInput.value.trim() : '';
                const customerEmail = customerEmailInput ? customerEmailInput.value.trim() : '';
                const customerMobileCode = customerMobileCodeInput ? customerMobileCodeInput.value : '';
                const customerMobile = customerMobileInput ? customerMobileInput.value.trim() : '';
                const customerAddress = customerAddressInput ? customerAddressInput.value.trim() : '';
                const customerCountryVal = countrySelect ? countrySelect.value : '';
                const customerStateVal = stateSelect ? stateSelect.value : '';
                const customerCityVal = citySelect ? citySelect.value : '';
                const customerPincode = customerPincodeInput ? customerPincodeInput.value.trim() : '';
                const customerWhatsappNum = customerWhatsappInput ? customerWhatsappInput.value.trim() : '';
                const customerWhatsappCodeVal = customerWhatsappCodeInput ? customerWhatsappCodeInput.value : '';


                if (!customerName || !customerEmail || !customerMobile || !customerAddress || !customerCountryVal || !customerStateVal || !customerCityVal || !customerPincode) {
                    if(orderFeedback) {
                        orderFeedback.textContent = 'Please fill in all required customer details.';
                        orderFeedback.className = 'text-center text-sm mt-4 text-red-500';
                    }
                    return;
                }
                if (!/^\S+@\S+\.\S+$/.test(customerEmail)) { 
                     if(orderFeedback) {
                        orderFeedback.textContent = 'Please enter a valid email address.';
                        orderFeedback.className = 'text-center text-sm mt-4 text-red-500';
                    }
                    return;
                }

                // Construct orderData to match emailService expectations more closely
                const orderData = {
                    customerName: customerName,
                    customerEmail: customerEmail,
                    mobileCode: customerMobileCode,
                    mobileNumber: customerMobile,
                    whatsappCode: customerWhatsappCodeVal,
                    whatsappNumber: customerWhatsappNum,
                    address: customerAddress, // Assuming emailService uses these directly
                    city: customerCityVal,
                    state: customerStateVal,
                    country: customerCountryVal,
                    pincode: customerPincode,
                    
                    orderItems: currentOrder, // currentOrder is already in the correct grouped structure
                    
                    totalOrderValue: orderTotalElement.textContent, // e.g., "123.00 Rs"
                    paymentMethod: "Pending" 
                };

                console.log("Order data to be sent:", JSON.stringify(orderData, null, 2));
                if(orderFeedback) {
                    orderFeedback.textContent = 'Placing your order...';
                    orderFeedback.className = 'text-center text-sm mt-4 text-sky-400';
                }
                placeOrderBtn.disabled = true; 
                placeOrderBtn.classList.add('opacity-50', 'cursor-not-allowed');

                try {
                    const response = await fetch(`${BACKEND_URL}/api/orders/place-order`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(orderData)
                    });
                    const result = await response.json();
                    if (response.ok) { 
                        if(orderFeedback) {
                            // Use the message from the backend, as orderId might not be in result if not saved to DB yet.
                            orderFeedback.textContent = result.message || 'Order placed successfully! We will contact you shortly.';
                            orderFeedback.className = 'text-center text-sm mt-4 text-green-500';
                        }
                        currentOrder = []; 
                        renderOrderSummary(); 
                    } else { 
                        if(orderFeedback) {
                            orderFeedback.textContent = result.message || `Error placing order: ${response.status}`;
                            orderFeedback.className = 'text-center text-sm mt-4 text-red-500';
                        }
                    }
                } catch (error) { 
                    console.error('Error placing order:', error);
                    if(orderFeedback) {
                        orderFeedback.textContent = 'An unexpected error occurred while placing your order. Please try again.';
                        orderFeedback.className = 'text-center text-sm mt-4 text-red-500';
                    }
                } finally {
                     if (currentOrder.length > 0 || !placeOrderBtn.disabled) { 
                        placeOrderBtn.disabled = false;
                        placeOrderBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                }
            });
        }
        
        if(clearOrderBtn) clearOrderBtn.addEventListener('click', () => { 
            console.log("Clear Order button clicked."); 
            currentOrder = []; 
            if(orderFeedback) {
                orderFeedback.textContent = 'Order cleared.';
                orderFeedback.className = 'text-center text-sm mt-4 text-red-500';
                setTimeout(() => { if(orderFeedback) orderFeedback.textContent = ''; }, 3000);
            }
            renderOrderSummary(); 
        });

        if(clearDetailsBtn) {
            clearDetailsBtn.addEventListener('click', () => { 
                if(customerNameInput) customerNameInput.value = '';
                if(customerEmailInput) customerEmailInput.value = '';
                if(customerMobileInput) customerMobileInput.value = '';
                if(customerWhatsappInput) customerWhatsappInput.value = '';
                if(customerAddressInput) customerAddressInput.value = '';
                if(customerPincodeInput) customerPincodeInput.value = '';
                
                if(countrySelect) {
                    countrySelect.value = 'India'; 
                    populateStates(countrySelect.value); 
                }
                if(orderFeedback) {
                    orderFeedback.textContent = 'Customer details cleared.';
                    orderFeedback.className = 'text-center text-sm mt-4 text-yellow-500';
                     setTimeout(() => { if(orderFeedback) orderFeedback.textContent = ''; }, 3000);
                }
            });
        }
        
        if(inquiryForm && contactFormFeedback) { 
            inquiryForm.addEventListener('submit', async function(e) {
                e.preventDefault(); 
                contactFormFeedback.textContent = 'Submitting your inquiry...';
                contactFormFeedback.className = 'contact-form-feedback text-sky-400';
                const submitButton = this.querySelector('button[type="submit"]');
                if(submitButton) submitButton.disabled = true; 

                const formData = new FormData(this); 
                
                try {
                    const response = await fetch(`${BACKEND_URL}/api/inquiry/submit`, {
                        method: 'POST',
                        body: formData, 
                    });
                    const result = await response.json();

                    if (response.ok) { 
                        contactFormFeedback.textContent = result.message || "Inquiry submitted successfully!";
                        contactFormFeedback.className = 'contact-form-feedback text-green-500';
                        this.reset(); 
                    } else { 
                        contactFormFeedback.textContent = result.message || `Error: ${response.statusText || response.status}`;
                        contactFormFeedback.className = 'contact-form-feedback text-red-500';
                    }
                } catch (error) { 
                    console.error('Error submitting inquiry form:', error);
                    contactFormFeedback.textContent = 'An unexpected error occurred. Please try again or contact us directly.';
                    contactFormFeedback.className = 'contact-form-feedback text-red-500';
                } finally {
                     if(submitButton) submitButton.disabled = false; 
                     setTimeout(() => {if(contactFormFeedback) contactFormFeedback.textContent = ''}, 7000); 
                }
            });
        }

        if(menuButton && mobileMenu) {
            menuButton.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));
        }
        
        const mobileNavLinks = Array.from(mobileMenu ? mobileMenu.querySelectorAll('a') : []);
        mobileNavLinks.forEach(link => {
            link.addEventListener('click', () => {
                if(mobileMenu) mobileMenu.classList.add('hidden');
            });
        });
        
        if(currentYearEl) currentYearEl.textContent = new Date().getFullYear();

        const navLinks = document.querySelectorAll('.nav-link');
        const sections = document.querySelectorAll('main section'); 
        const header = document.querySelector('header');
        let headerHeight = header ? header.offsetHeight : 70; 

        window.addEventListener('resize', () => {
            headerHeight = header ? header.offsetHeight : 70;
        });
        
        /**
         * Updates the active state of navigation links based on scroll position.
         */
        function updateActiveNavLink() { 
            let currentSectionId = '';
            const availableSections = document.querySelectorAll('main section'); 
            availableSections.forEach(section => {
                const sectionTop = section.offsetTop - headerHeight - 20; 
                if (window.scrollY >= sectionTop) {
                    currentSectionId = section.getAttribute('id');
                }
            });

            navLinks.forEach(link => {
                link.classList.remove('nav-link-active');
                if (link.getAttribute('href') === `#${currentSectionId}`) {
                    link.classList.add('nav-link-active');
                }
            });
        }
        
        window.addEventListener('load', () => {
            fetchAndDisplayCustomerProducts(); 
            populateCountryCodeDropdowns();
            populateCountries(); 
            updateActiveNavLink(); 
            renderOrderSummary(); 
        });
        window.addEventListener('scroll', updateActiveNavLink); 

    </script>
</body>
</html>
